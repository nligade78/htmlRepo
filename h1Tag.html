import React, { useState } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  TablePagination,
  TableSortLabel,
  Typography,
  Box,
  TextField
} from '@mui/material';

// Sample JSON data
const jsonData = {
  "releatedProviderAdditionalDetails": {
    "confidenceScore": {
      "Network1": {
        "POA_KEYs": [6001549220, 6001549221, 6001549222, 6001549223, 6001549224, 6001549225, 6001549226, 6001549227, 6001549228],
        "confidenceScoreOfNetwork": "94.44%",
        "countOfPOA_KEYs": 9
      },
      "Network2": {
        "POA_KEYs": [6001549220, 6001549221, 6001549222, 6001549223, 6001549224, 6001549225, 6001549226, 6001549227, 6001549228, 6001549229, 6001549210],
        "confidenceScoreOfNetwork": "94.44%",
        "countOfPOA_KEYs": 10
      },
      "Network3": {
        "POA_KEYs": [6001549220, 6001549221, 6001549222, 6001549223, 6001549224, 6001549225, 6001549226, 6001549227, 6001549228, 6001549229, 6001549210, 6001549211],
        "confidenceScoreOfNetwork": "94.44%",
        "countOfPOA_KEYs": 11
      },
      "avarageOfConfidenceScore": "85%",
      "countOfUniquePOA_Keys": 4,
      "uniquePOAKeys": [
        10000023029,
        10000023028,
        10000023024,
        10000023023
      ]
    }
  }
};

const DynamicTable = ({ data }) => {
  const confidenceScores = data.releatedProviderAdditionalDetails.confidenceScore;
  const networks = Object.keys(confidenceScores).filter(key => typeof confidenceScores[key] === 'object' && confidenceScores[key].POA_KEYs);

  // Collect and sort all POA_KEYs
  const allPOAKeys = new Set();
  networks.forEach(network => {
    confidenceScores[network].POA_KEYs.forEach(key => allPOAKeys.add(key));
  });
  const sortedPOAKeys = Array.from(allPOAKeys).sort((a, b) => a - b);

  // State for pagination, sorting, and search
  const [page, setPage] = useState(0);
  const [rowsPerPage, setRowsPerPage] = useState(5);
  const [order, setOrder] = useState('asc');
  const [orderBy, setOrderBy] = useState('POA_KEY');
  const [searchQuery, setSearchQuery] = useState('');

  // Sorting function
  const handleRequestSort = (property) => {
    const isAsc = orderBy === property && order === 'asc';
    setOrder(isAsc ? 'desc' : 'asc');
    setOrderBy(property);
  };

  const handleChangePage = (event, newPage) => {
    setPage(newPage);
  };

  const handleChangeRowsPerPage = (event) => {
    setRowsPerPage(parseInt(event.target.value, 10));
    setPage(0);
  };

  const handleSort = (array, comparator) => {
    const stabilizedThis = array.map((el, index) => [el, index]);
    stabilizedThis.sort((a, b) => {
      const order = comparator(a[0], b[0]);
      if (order !== 0) return order;
      return a[1] - b[1];
    });
    return stabilizedThis.map((el) => el[0]);
  };

  const getComparator = (order, orderBy) => {
    return order === 'desc'
      ? (a, b) => descendingComparator(a, b, orderBy)
      : (a, b) => -descendingComparator(a, b, orderBy);
  };

  const descendingComparator = (a, b, orderBy) => {
    if (orderBy === 'POA_KEY') {
      return a - b;
    }
    return 0;
  };

  const sortedKeys = handleSort(sortedPOAKeys, getComparator(order, orderBy));

  // Extract average confidence score
  const averageConfidenceScore = confidenceScores.avarageOfConfidenceScore;

  // Filter POA_KEYs based on search query
  const filteredKeys = sortedKeys.filter(key => key.toString().includes(searchQuery));

  return (
    <Paper>
      <Box display="flex" justifyContent="flex-end" padding={2}>
        <TextField
          label="Search POA_KEY"
          variant="outlined"
          size="small"
          value={searchQuery}
          onChange={(e) => {
            setSearchQuery(e.target.value);
            setPage(0); // Reset page to 0 when search query changes
          }}
          style={{ width: '300px' }}
        />
      </Box>
      <TableContainer>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>
                <TableSortLabel
                  active={orderBy === 'POA_KEY'}
                  direction={orderBy === 'POA_KEY' ? order : 'asc'}
                  onClick={() => handleRequestSort('POA_KEY')}
                >
                  <strong>POA_KEYs</strong>
                </TableSortLabel>
              </TableCell>
              {networks.map(network => (
                <TableCell key={network}><strong>{network}</strong></TableCell>
              ))}
              <TableCell><strong>Average Confidence Score</strong></TableCell>
            </TableRow>
            <TableRow>
              <TableCell><strong>Confidence Score</strong></TableCell>
              {networks.map(network => (
                <TableCell key={network}>
                  <Typography>{confidenceScores[network].confidenceScoreOfNetwork}</Typography>
                </TableCell>
              ))}
              <TableCell rowSpan={rowsPerPage + 1} align="center">
                <Typography>{averageConfidenceScore}</Typography>
              </TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {filteredKeys.slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage).map(key => (
              <TableRow key={key}>
                <TableCell>{key}</TableCell>
                {networks.map(network => (
                  <TableCell key={network}>
                    {confidenceScores[network].POA_KEYs.includes(key) ? 'Y' : 'N'}
                  </TableCell>
                ))}
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
      <TablePagination
        rowsPerPageOptions={[5, 10, 25]}
        component="div"
        count={filteredKeys.length}
        rowsPerPage={rowsPerPage}
        page={page}
        onPageChange={handleChangePage}
        onRowsPerPageChange={handleChangeRowsPerPage}
      />
    </Paper>
  );
};

const App = () => <DynamicTable data={jsonData} />;

export default App;